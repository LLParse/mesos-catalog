From 547c5354619438a621e6c50228ecc58178933ed8 Mon Sep 17 00:00:00 2001
From: Jim Carroll <jim@dontcallme.com>
Date: Wed, 9 Mar 2016 17:09:30 -0500
Subject: [PATCH] Patch to build on alpine. See alpine/README.

---
 configure.ac     | 18 ++++++++++++++++++
 src/linux/fs.cpp |  4 ++++
 src/linux/fs.hpp |  2 ++
 5 files changed, 86 insertions(+)
 create mode 100644 alpine/README
 create mode 100644 alpine/build.sh

diff --git a/configure.ac b/configure.ac
index a20382e..581d176 100644
--- a/configure.ac
+++ b/configure.ac
@@ -231,6 +231,13 @@ AC_ARG_ENABLE([bundled-wheel],
                               PYTHONPATH]),
               [without_bundled_wheel=yes], [])
 
+AC_ARG_ENABLE([alpine],
+  [AS_HELP_STRING([--enable-alpine],
+  [enable alpine build])],
+  [use_alpine=$enableval],
+  [use_alpine=no])
+
+
 # This is used to make distcheck and python install work together. For more
 # information, see the comment above AM_DISTCHECK_CONFIGURE_FLAGS in
 # Makefile.am.
@@ -311,6 +318,11 @@ case "${target_os}" in
     AC_MSG_ERROR("Mesos is currently unsupported on your platform.")
 esac
 
+AS_CASE([x$use_alpine],
+  [xyes],[
+    LIBS="$LIBS -lfts"
+  ]
+)
 
 # Used for conditionally including source files.
 AM_CONDITIONAL([OS_LINUX], [test "x$OS_NAME" = "xlinux"])
@@ -569,6 +581,12 @@ AS_CASE($ax_cv_cxx_compiler_vendor,
   ]
 )
 
+AS_CASE([x$use_alpine],
+  [xyes],[
+    AC_DEFINE([ALPINE], 1, [System build set to Alpine])
+  ]
+)
+
 # Ensure we can build the C++11 features we expect, and set the --std=
 # flag and CXXFLAG environment variable as appropriate.
 AX_CXX_COMPILE_STDCXX_11([noext], [mandatory])
diff --git a/src/linux/fs.cpp b/src/linux/fs.cpp
index dbf9475..6c64d97 100644
--- a/src/linux/fs.cpp
+++ b/src/linux/fs.cpp
@@ -275,6 +275,9 @@ Try<MountTable> MountTable::read(const string& path)
 
 Try<FileSystemTable> FileSystemTable::read()
 {
+#ifdef ALPINE
+  return Try<FileSystemTable>::error("This stupid OS doesn't support fstab.");
+#else
   // Mutex for guarding calls into non-reentrant fstab functions. We
   // use a static local variable to avoid unused variable warnings.
   static std::mutex mutex;
@@ -310,6 +313,7 @@ Try<FileSystemTable> FileSystemTable::read()
   }
 
   return table;
+#endif
 }
 
 
diff --git a/src/linux/fs.hpp b/src/linux/fs.hpp
index 4525a5d..f795d44 100644
--- a/src/linux/fs.hpp
+++ b/src/linux/fs.hpp
@@ -17,7 +17,9 @@
 #ifndef __FS_HPP__
 #define __FS_HPP__
 
+#ifndef ALPINE
 #include <fstab.h>
+#endif
 #include <mntent.h>
 
 #include <sys/mount.h>
-- 
2.5.4 (Apple Git-61)

